# 4. Vagrant におけるネットワーク

Vagrant は、柔軟性を最大限に発揮できるよう、3つの選択肢をネットワークに関して提供して
います。

- フォワードされたポート
- ホストのみのネットワーク (V2ではプライベートネットワーク)
- ブリッジされたネットワーク

### 4.1 フォワードされたポート

- ホストのポートをゲストのポートにフォワードする
- ゲストのIPを指定しなくてもアクセスできる

__1つの例__

仮にゲストのポート `80` をホストのポート `8080` にフォワードしたなら、メインマ
シンで `localhost:8080` を読み込めば、ゲストのWebサーバーにアクセスできるでしょう。


#### 4.1.1 長所と短所

##### 長所

- セットアップが非常にシンプル

##### 短所

- フォワードしたいポートは、すべて明示的に指定しなければならない


フォワードされたポートは、使っているコンピュータそのものの外からもアクセスできます。
使っているコンピュータでファイアウォールが動作していなければ、そのコンピュータのIPと待
ち受け使われているポートがわかれば、ローカルネットワーク内の任意のコンピュータがその仮
想マシンにアクセスできます。


#### 4.1.2 基本的な使用方法

```ruby
config.vm.forward_port 80, 8080
```

これらの定義の変更は、`vagrant reload` とするまでは、実行中のマシンに影響しない


#### 4.1.3 衝突の検出と修正

Vagrant には、ポートの衝突検出機能が組み込まれています。ポートが衝突するのは、ポートの
定義がシステム上ですでに使われているポートとぶつかってしまった場合です。

- デフォルトでは、Vagrant はエラーを表示する
- 自動的に衝突を回避することもできる

```ruby
# 自動でポートの衝突を避ける
config.vm.forward_port 80, 8080, auto_correct: true
```

Vagrant は自動修正用のポートを、`2200` から `2250` の間で選択します。
この範囲も、Vagrantfile の設定でカスタマイズ可能です

```ruby
config.vm.usable_port_range = (2200..2250)
```


#### 4.1.4 TCP 対 UDP

デフォルトでは、フォワードされたポートはTCP接続を対象とする。
UDPパケットもフォワードしたい場合は、UDPポートフォワードの設定を追加する必要がある。

```ruby
conifg.vm.forward_port 80, 8080, protocol: 'udp'
```

これは UDPパケットだけをフォワードします。どちらのプロトコルもフォワードしたい場合は、
2つのフォワードポートの宣言が必要となる。


## 4.2 ホストのみのネットワーク

- ゲストマシンに静的なIPアドレスを割り当てる
- このネットワークにはホストマシンとゲストマシンしかアクセスできません。

### 4.2.1 長所と短所

#### 長所

- ホストとゲスト以外はネットワークにはアクセスできないため、セキュアである

#### 短所

- 隔離されているため、ホスト以外はアクセスできない

### 4.2.2 基本的な使用方法

```ruby
config.vm.network 'hostonly', '192.168.33.10'
```

2番目の引数はゲストマシンに割り当てる静的なIPアドレスです。
これには、任意のアドレスを使うことができますが、RFCの仕様に従い、プライベートとして予
約されているネットワークの範囲を使うようにする。

* この変更は `vagrant reload` するまで反映されません。

__確認__

```
$ ping 192.168.33.10
# 成功した場合
64 bytes from 192.168.33.10: icmp_seq=0 ttl=64 time=0.532 ms
64 bytes from 192.168.33.10: icmp_seq=1 ttl=64 time=0.237 ms
64 bytes from 192.168.33.10: icmp_seq=2 ttl=64 time=0.236 ms
64 bytes from 192.168.33.10: icmp_seq=3 ttl=64 time=0.269 ms

# 失敗した場合
Request timeout for icmp_seq 0
Request timeout for icmp_seq 1
```


#### 4.2.3 ゲストのオペレーティングシステムへの依存性


## 4.3 ブリッジのネットワーク

- 仮想マシンを物理マシン上のデバイスにブリッジする
- 仮想マシンをネットワーク上の別の物理マシンのように見せる
- DHCP でIPアドレスが割り当てられる

### 4.3.1 長所と短所

#### 長所

- IPアドレスを仮想マシンに持たせるメリットをすべて手にすることができる

#### 短所

- 隔離されていないということは裏を返せば、隔離する必要がある場合は欠点となる
- 静的なIPアドレスを指定できない

### 4.3.2 基本的な使用法

```ruby
config.vm.network 'bridged'
```

* この変更は `vagrant reload` するまで反映されません。

__IPアドレスの確認__

```
$ vagrant ssh
vagrant@precise64:~$ ifconfig
eth1      Link encap:Ethernet  HWaddr 08:00:27:81:10:ab  
          inet addr:172.29.x.x  <-

vagrant@precise64:~$ logout
$ ping 172.29.x.x
```

## 4.4 ネットワークの選択肢の組み合わせ

- ネットワークのそれぞれの選択肢には、一連の長所と短所がある
- Vagrant では、複数のネットワークオプションを有効にできる

```ruby
config.vm.forward_port 80, 8080
config.vm.network 'hostonly', '192.168.33.10'
config.vm.network 'bridged'
```


## 4.5 第1番目のネットワークインタフェースとしての NAT に対する要求

- VitrualBox の場合、Vagrant の仮想マシンにアタッチされる第1番目のネットワークデバイスは NAT デバイスでなくてはいけない
- `hostonly` `bridged` の場合、仮想マシンからは`eh1` や `eth2` などとして見える
- `eth0` `en0`  は概して常に NAT デバイスとなる

## 4.6 この後は？

- Vagrant を最も効率良く使うためには、ネットワークが鍵となる
- ネットワークを自動化すれば、仮想マシンにSSHしたりせずに済むということです
